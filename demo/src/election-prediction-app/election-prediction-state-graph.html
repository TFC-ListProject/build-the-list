<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="election-prediction-district-card.html">

<dom-module id="election-prediction-state-graph">
  <template>
    <style include="iron-flex-alignment"></style>
    <style include="iron-flex">
      :host {
        @apply(--layout-horizontal);
      }

      h3 {
        @apply(--paper-font-subhead);
      }

      paper-material {
        background-color: white;
        margin-bottom: 16px;
      }

      paper-button[raised] {
        background-color: var(--accent-color);
        color: white;
      }

      paper-button.make-prediction {
        margin-bottom: 16px;
      }

      .buttons paper-button {
        color: var(--primary-color);
      }

      .buttons paper-button:last-of-type {
        color: var(--accent-color);
      }

      paper-tooltip {
        --paper-tooltip-opacity: 1;
        --paper-tooltip-text-color: #white;
        --paper-tooltip: {
          @apply(--shadow-elevation-4dp);
          font-size: 13px;
        };
      }

      svg {
        filter: drop-shadow(16px 16px 20px rgba(0, 0, 0, 0.14));
        height: calc(100vh - 76px);
      }

      svg .district {
        fill: var(--paper-red-500);
      }

      .graph {
        position: relative;
        margin-bottom: 0;
      }

      .controls {
        padding: 4px 16px;
      }

      .controls paper-input, .controls .control {
        margin-right: 32px;
      }

      paper-icon-button {
        color: var(--paper-grey-600);
        transition: color 250ms ease-in-out;
      }

      paper-icon-button:hover {
        color: var(--paper-grey-700);
      }

      paper-icon-item {
        --paper-item-icon: {
          background-color: var(--paper-red-500);
          border: 1px solid var(--paper-grey-700);
        }
      }

      paper-icon-item.democrat {
        --paper-item-icon: {
          background-color: var(--paper-blue-700);
          border: 1px solid var(--paper-grey-700);
        }
      }
    </style>
    <iron-ajax auto url="../src/geojson/[[state]]/[[year]]/[[election]].json" params="{}" last-response="{{response}}" loading="{{loading}}"></iron-ajax>
    <div>
    <paper-material class="controls layout horizontal center">
      <paper-dropdown-menu class="flex control" label="State">
        <paper-listbox attr-for-selected="value" class="dropdown-content" selected="{{state}}">
          <paper-item value="nj">New Jersey</paper-item>
          <paper-item value="va">Virgina</paper-item>
        </paper-listbox>
      </paper-dropdown-menu>
      <paper-dropdown-menu class="flex control" label="Election">
        <paper-listbox attr-for-selected="value" class="dropdown-content" selected="{{election}}">
          <paper-item value="senate">Senate</paper-item>
          <paper-item value="house">House</paper-item>
        </paper-listbox>
      </paper-dropdown-menu>
      <paper-dropdown-menu class="flex control" hidden$="[[isPredicting]]" label="Year">
        <paper-listbox attr-for-selected="value" class="dropdown-content" selected="{{year}}">
          <paper-item value="2014">2014</paper-item>
          <paper-item value="2015">2015</paper-item>
          <paper-item value="2016">2016</paper-item>
        </paper-listbox>
      </paper-dropdown-menu>
    </paper-material>
    <paper-button active="{{isPredicting}}" class="make-prediction" hidden$="[[isPredicting]]" raised toggles>Make prediction</paper-button>
    <paper-material class="controls" hidden$="[[!isPredicting]]">
      <div class="layout horizontal center">
        <paper-input class="flex control" label="Turnout" type="number" value="0">
          <div suffix>%</div>
        </paper-input>
        <paper-input class="flex control" label="Money spent" type="number" value="0">
          <div prefix>$</div>
        </paper-input>
        <paper-checkbox class="control">Incumbent</paper-checkbox>
      </div>
      <div class="buttons layout horizontal flex end-justified">
        <paper-button active="{{!isPredicting}}" toggles>Cancel</paper-button>
        <paper-button>Predict</paper-button>
      </div>
    </paper-material>
    <election-prediction-district-card district="[[district]]" hidden$="[[!district.NAME]]">
    </election-prediction-district-card>
  </div>
  <div class="flex">
    <div class="graph flex layout horizontal center-justified">
      <div id="vis" class="flex layout horizontal center-justified">
        <svg id="svg" viewBox="0 0 500 500"></svg>
      </div>
    </div>
  </div>
  </template>
  <script>
    Polymer({
      is: 'election-prediction-state-graph',
      properties: {
        district: {
          type: Object,
          value() {
            return {
              NAME: undefined
            };
          },
          notify: true
        },
        state: {
          type: String,
          notify: true,
          value: 'nj'
        },
        year: {
          type: String,
          value: '2016'
        },
        election: {
          type: String,
          value: 'senate'
        },
        tooltipText: String
      },

      observers: ['onResponse_(response, isAttached)'],

      onResponse_(response) {
        console.log(response);
        let width = 500;
        let height = 500;

        const projection = d3.geoAlbersUsa().scale(1).translate([0, 0]);
        const path = d3.geoPath().projection(projection);

        const svg = d3.select(this.$.svg); //.attr('width', width).attr('height', height);
        const bounds = path.bounds(response);
        const s = 0.95 / Math.max((bounds[1][0] - bounds[0][0]) / width, (bounds[1][1] - bounds[0][1]) / height);
        const t = [(width - s * (bounds[1][0] + bounds[0][0])) / 2, (height - s * (bounds[1][1] + bounds[0][1])) / 2];

        projection.scale(s).translate(t);
        d3.selectAll('path').remove();
        svg.append('g')
           .selectAll('path')
           .data(response.features)
           .enter()
           .append('path')
           .attr('d', path)
           .attr('id', d => `district-${d.properties.NAME}`)
           .attr('stroke', 'white')
           .attr('fill-opacity', 0.8)
           .attr('class', d => {
             const rand = d3.randomUniform(1, 4)();
             switch (parseInt(rand)) {
               case 1:
               return 'district red';
               case 2:
                return 'district blue';
              default:
                return 'district purple';
             }
             return 'district';
           })
           .on('mouseover', d => {
             console.log('Some tooltip for ', d);
           })
           .on('click', d => {
             this.district = d.properties;
           });
      }
    });
  </script>
</dom-module>
